<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <script>
  var pc1Local;
  function _startScreenCapture() {
    if (navigator.getDisplayMedia) {
      return navigator.getDisplayMedia({video: true});
    } else if (navigator.mediaDevices.getDisplayMedia) {
      return navigator.mediaDevices.getDisplayMedia({video: true});
    } else {
      return navigator.mediaDevices.getUserMedia({video: {mediaSource: 'screen'}});
    }
  }
async function broadcast() {
  const stream = await _startScreenCapture()
  const videoTracks = stream.getVideoTracks();
  const servers = null;
  pc1Local = new RTCPeerConnection({iceServers: [{urls: "stun:stun.stunprotocol.org"}]});
  pc1Local.onicecandidate = (ic) => {
      let val = JSON.parse(document.getElementById('ice-candidate-out').value || '[]') 
          if (ic.candidate) {
            val.push(ic.candidate)
          }
      document.getElementById('ice-candidate-out').value = JSON.stringify(val)
  }
  stream.getTracks().forEach(track => pc1Local.addTrack(track, stream));
  pc1Local.createOffer({}).then(gotDescription1Local, onCreateSessionDescriptionError);
}

function gotDescription1Remote(desc) {
  pc1Local.setRemoteDescription(desc);
}

function gotDescription1Local(desc) {
  pc1Local.setLocalDescription(desc);
  document.getElementById('local-description').value = JSON.stringify(desc);
}

function onCreateSessionDescriptionError(error) {
  console.log(`Failed to create session description: ${error.toString()}`);
}

function gotRemote() {
    gotDescription1Remote(JSON.parse(document.getElementById('remote-description').value))
}

function gotIceCandidate() {
    JSON.parse(document.getElementById('ice-candidate-in').value).forEach((c) => pc1Local.addIceCandidate(c))
    
}
  </script>
</head>
<body>
  <button onclick="broadcast()">broadcast</button><br>
  Local Description;<br>
  <textarea id="local-description"></textarea><br>
  Remote Description;<br>
  <textarea id="remote-description"></textarea><br>
  <button onclick="gotRemote()">received remote</button>
  ICE candidate to send<br>
  <textarea id="ice-candidate-out"></textarea><br>
  ICE candidate received<br>
  <textarea id="ice-candidate-in"></textarea><br>
  <button onclick="gotIceCandidate()">received remote</button>
</body>
</html>
