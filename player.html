<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <script>
  let dc;
  const id = location.href.split('/')[4] || 'undefinedLOL'
  let play = (async () => {
    const pc = new RTCPeerConnection({iceServers: [{urls: "stun:stun.l.google.com:19302"}]});
    pc.ontrack = (event) => {
      if (document.getElementById('video').srcObject !== event.streams[0]) {
        document.getElementById('video').srcObject = event.streams[0];
        document.getElementById("video").play()
      }
    };
    const res = await fetch(`/stream/${id}`, {
      method: 'GET',
      headers:{
        'Content-Type': 'application/json'
      }
    })
    const data = await res.json();
    pc.setRemoteDescription(data.offer, () => {}, (error) => alert(error));
    data.candidates.forEach((c) => {
      pc.addIceCandidate(c)
    })
    pc.ondatachannel = (ev) => {
      dc = ev.channel
    }
    pc.createAnswer(async(desc) => {
      pc.setLocalDescription(desc, () => {}, (error) => alert(error));
      await fetch(`/stream/${id}/answer`, {
        method: 'POST',
        body: JSON.stringify(desc),
        headers:{
          'Content-Type': 'application/json'
        }
      })
    }, (error) => alert(error));
    pc.oniceconnectionstatechange = (event) => {
      if (pc.iceConnectionState === "failed" ||
          pc.iceConnectionState === "disconnected" ||
          pc.iceConnectionState === "closed") {
        alert('disconnected')
      }
    }
  })
function takeControl() {
  const elem = document.getElementById("video");
  // Start by going fullscreen with the element.  Current implementations
  // require the element to be in fullscreen before requesting pointer
  // lock--something that will likely change in the future.
  elem.requestFullscreen = elem.requestFullscreen    ||
                           elem.mozRequestFullscreen ||
                           elem.mozRequestFullScreen || // Older API upper case 'S'.
                           elem.webkitRequestFullscreen;
  elem.requestFullscreen();
}

document.addEventListener("mousemove", function(e) {
  var movementX = e.movementX       ||
                  e.mozMovementX    ||
                  e.webkitMovementX ||
                  0,
      movementY = e.movementY       ||
                  e.mozMovementY    ||
                  e.webkitMovementY ||
                  0;

  if (document.pointerLockElement) {
    const elem = document.getElementById("video");
    dc.send(JSON.stringify({mouse: {x: movementX / elem.offsetWidth, y: movementY / elem.offsetHeight}}))
  }
}, false);

['down', 'up'].forEach((down) => {
  document.addEventListener(`mouse${down}`, function(e) {
    if (document.pointerLockElement) {
      dc.send(JSON.stringify({mouseClick: {down, button: {
        0: 'left',
        1: 'midde',
        2: 'right',
      }[e.button]}}))
    }
  }, false);
});

['down', 'up'].forEach((down) => {
  document.addEventListener(`key${down}`, function(e) {
    if (document.pointerLockElement) {
      dc.send(JSON.stringify({keyboard: {down, key: e.key.toLowerCase().replace('arrow', '')}}))
    }
  }, false);
});

function fullscreenChange() {
  const elem = document.getElementById("video");
  if (document.webkitFullscreenElement === elem ||
      document.mozFullscreenElement === elem ||
      document.mozFullScreenElement === elem) { // Older API upper case 'S'.
    // El elemento esta en pantalla completa, ahora podemos hacer el request de pointer lock
    elem.requestPointerLock = elem.requestPointerLock    ||
                              elem.mozRequestPointerLock ||
                              elem.webkitRequestPointerLock;
    elem.requestPointerLock();
  }
}

document.addEventListener('fullscreenchange', fullscreenChange, false);
document.addEventListener('mozfullscreenchange', fullscreenChange, false);
document.addEventListener('webkitfullscreenchange', fullscreenChange, false);

  </script>
</head>
<body>
<button onclick="play();">Start</button>
<button onclick="takeControl();">takeControl</button>
  <video id="video"></video>
</body>
</html>
