<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <script>
  const id = location.href.split('/')[4] || 'undefinedLOL'
  let pc = new RTCPeerConnection({iceServers: [{urls: "stun:stun.stunprotocol.org"}]});
  pc.ontrack = gotRemoteStream;
  (async () => {
    const res = await fetch(`/stream/${id}`, {
      method: 'GET',
      headers:{
        'Content-Type': 'application/json'
      }
    })
    const data = await res.json();
    pc.setRemoteDescription(data.offer, onSetRemoteSuccess, onSetSessionDescriptionError);
    data.candidates.forEach((c) => {
      pc.addIceCandidate(c)
    })
    pc.createAnswer(onCreateAnswerSuccess, onCreateSessionDescriptionError);
  })()

  function onCreateSessionDescriptionError(error) {
    alert(`Failed to create session description: ${error.toString()}`);
  }

  function onSetLocalSuccess() {
  }

  function onSetRemoteSuccess() {
  }

  function onSetSessionDescriptionError(error) {
    alert(`Failed to set session description: ${error.toString()}`);
  }

  function gotRemoteStream(event) {
    if (document.getElementById('video').srcObject !== event.streams[0]) {
      document.getElementById('video').srcObject = event.streams[0];
    }
  }

  async function onCreateAnswerSuccess(desc) {
    pc.setLocalDescription(desc, onSetLocalSuccess, onSetSessionDescriptionError);
    await fetch(`/stream/${id}/answer`, {
      method: 'POST',
      body: JSON.stringify(desc),
      headers:{
        'Content-Type': 'application/json'
      }
    })
  }

  </script>
</head>
<body>
  <video id="video" autoplay="true"></video>
</body>
</html>
