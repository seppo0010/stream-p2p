<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <script>
  const offer = {candidates: []};
  const id = location.href.split('/')[4] || btoa(Math.random())
  history.replaceState(null, '', `/streamer/${id}`)
  let pc;
  function _startScreenCapture() {
    if (navigator.getDisplayMedia) {
      return navigator.getDisplayMedia({video: true});
    } else if (navigator.mediaDevices.getDisplayMedia) {
      return navigator.mediaDevices.getDisplayMedia({video: true});
    } else {
      return navigator.mediaDevices.getUserMedia({video: {mediaSource: 'screen'}});
    }
  }

  async function broadcast() {
    const stream = await _startScreenCapture()
    const videoTracks = stream.getVideoTracks();
    const servers = null;
    pc = new RTCPeerConnection({iceServers: [{urls: "stun:stun.stunprotocol.org"}]});
    pc.onicegatheringstatechange = async (e) => {
      if (e.target.iceGatheringState === 'complete') {
        if (!offer.offer || !offer.candidates) {
          alert('No SDP or no candidates :(')
          return
        }
        const res = await fetch(`/stream/${id}`, {
          method: 'POST',
          body: JSON.stringify(offer),
          headers:{
            'Content-Type': 'application/json'
          }
        })
        waitForAnswer();
      }
    }
    pc.onicecandidate = (ic) => {
      if (ic.candidate) {
        offer.candidates.push(ic.candidate)
      }
    }
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
    pc.createOffer({}).then(gotDescription1Local, onCreateSessionDescriptionError);
  }

  async function waitForAnswer() {
    let res = await fetch(`/stream/${id}/answer`, {
      method: 'GET',
    })
    let data = await res.json()
    gotDescription1Remote(data)
  }

  function gotDescription1Remote(desc) {
    pc.setRemoteDescription(desc);
  }

  function gotDescription1Local(desc) {
    pc.setLocalDescription(desc);
    offer.offer = desc;
  }

  function onCreateSessionDescriptionError(error) {
    alert(`Failed to create session description: ${error.toString()}`);
  }

  function gotRemote() {
      gotDescription1Remote(JSON.parse(document.getElementById('remote-description').value))
  }
  </script>
</head>
<body>
  <button onclick="broadcast()">broadcast</button><br>
</body>
</html>
