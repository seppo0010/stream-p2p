<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <script>
  var pc2 = new RTCPeerConnection({iceServers: [{urls: "stun:stun.stunprotocol.org"}]});
  pc2.onicecandidate = (ic) => {
      let val = JSON.parse(document.getElementById('ice-candidate-out').value || '[]') 
          if (ic.candidate) {
            val.push(ic.candidate)
          }
      document.getElementById('ice-candidate-out').value = JSON.stringify(val)
  }
  pc2.ontrack = gotRemoteStream;

function onCreateSessionDescriptionError(error) {
  console.log(`Failed to create session description: ${error.toString()}`);
}

function onReceiveOfferSuccess(desc) {
  pc2.setRemoteDescription(desc, onSetRemoteSuccess, onSetSessionDescriptionError);
  // Since the 'remote' side has no media stream we need
  // to pass in the right constraints in order for it to
  // accept the incoming offer of audio and video.
  pc2.createAnswer(onCreateAnswerSuccess, onCreateSessionDescriptionError);
}

function gotOffer() {
    onReceiveOfferSuccess(JSON.parse(document.getElementById('remote-offer').value))
}

function onSetLocalSuccess() {
  console.log(`setLocalDescription complete`);
}

function onSetRemoteSuccess() {
  console.log(`setRemoteDescription complete`);
}

function onSetSessionDescriptionError(error) {
  console.log(`Failed to set session description: ${error.toString()}`);
}

function gotRemoteStream(event) {
  if (document.getElementById('video').srcObject !== event.streams[0]) {
    document.getElementById('video').srcObject = event.streams[0];
    console.log('pc2 received remote stream', event);
  }
}

function onCreateAnswerSuccess(desc) {
  console.log(`Answer from pc2:
${desc.sdp}`);
  console.log('pc2 setLocalDescription start');
  pc2.setLocalDescription(desc, onSetLocalSuccess, onSetSessionDescriptionError);
  document.getElementById('answer').value = JSON.stringify(desc)
}
function gotIceCandidate() {
    JSON.parse(document.getElementById('ice-candidate-in').value).forEach((c) => pc2.addIceCandidate(c))
}

  </script>
</head>
<body>
  remote offer<br>
  <textarea id="remote-offer"></textarea><br>
  <button onclick="gotOffer()">play</button><br>
  answer<br>
  <textarea id="answer"></textarea><br>
  ICE candidate to send<br>
  <textarea id="ice-candidate-out"></textarea><br>
  ICE candidate received<br>
  <textarea id="ice-candidate-in"></textarea><br>
  <button onclick="gotIceCandidate()">received remote</button>
  <video id="video" autoplay="true"></video>
</body>
</html>
